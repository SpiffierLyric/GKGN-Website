<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Would You Rather? Pilk Edition</title>
    <style>
        :root {
            --glass: rgba(255, 255, 255, 0.1);
            --accent: #00d2ff;
            --price-tag: #45f542;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: white;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            margin: 0;
            padding: 20px;
        }

        h1 { font-size: 2.8rem; text-transform: uppercase; letter-spacing: 5px; margin-bottom: 5px; text-shadow: 0 0 20px var(--accent); text-align: center; }
        .subtitle { margin-bottom: 30px; color: rgba(255, 255, 255, 0.6); letter-spacing: 2px; text-align: center; }

        .game-container { display: flex; gap: 30px; flex-wrap: wrap; justify-content: center; max-width: 1200px; }

        .card {
            background: var(--glass);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 20px;
            padding: 25px;
            width: 380px;
            text-align: center;
            transition: all 0.2s ease;
            box-shadow: 0 15px 35px rgba(0,0,0,0.5);
            display: flex;
            flex-direction: column;
            align-items: center;
            cursor: pointer;
        }

        .card:hover { transform: translateY(-5px); border-color: var(--accent); background: rgba(255, 255, 255, 0.15); }

        .glass-visual {
            width: 70px;
            height: 130px;
            border: 4px solid #fff;
            border-top: none;
            border-bottom-left-radius: 12px;
            border-bottom-right-radius: 12px;
            margin-bottom: 20px;
            position: relative;
            overflow: hidden;
            display: flex;
            flex-direction: column-reverse;
            pointer-events: none;
        }

        .layer { width: 100%; transition: height 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); }

        .mixture-list {
            list-style: none;
            padding: 0;
            font-size: 0.95rem;
            line-height: 1.8;
            width: 100%;
            text-align: left;
            margin-bottom: 20px;
            min-height: 100px;
        }

        .percentage { font-weight: bold; color: var(--accent); }
        .oz-label { opacity: 0.7; font-size: 0.85rem; pointer-events: none;}

        .total-price {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--price-tag);
            text-shadow: 0 0 10px rgba(69, 245, 66, 0.3);
            border-top: 1px solid rgba(255,255,255,0.1);
            padding-top: 15px;
            width: 100%;
            pointer-events: none;
        }

        .footer { margin-top: 50px; color: rgba(255, 255, 255, 0.4); }
    </style>
</head>
<body>

    <h1>Would You Rather? Pilk Edition</h1>
    <div class="subtitle">Click a card to roll</div>

    <div class="game-container">
        <div class="card" id="cardA" onclick="generateGame()">
            <h2>Original Pilk</h2>
            <div class="glass-visual" id="vizA"></div>
            <ul class="mixture-list" id="leftContent"></ul>
            <div class="total-price" id="leftTotal">Total: $0.00</div>
        </div>

        <div class="card" id="cardB" onclick="generateGame()">
            <h2>Chaos Pilk</h2>
            <div class="glass-visual" id="vizB"></div>
            <ul class="mixture-list" id="rightContent"></ul>
            <div class="total-price" id="rightTotal">Total: $0.00</div>
        </div>
    </div>

    <div class="footer">Brought to you by GKGN</div>

    <script>
        let registry = { ilk: [], p: [] };

        // --- DATA LOADING ---
        async function loadData() {
            try {
                const [ilkResponse, pResponse] = await Promise.all([
                    fetch('../data/ilks.csv'),
                    fetch('../data/ps.csv')
                ]);

                const ilkText = await ilkResponse.text();
                const pText = await pResponse.text();

                registry.ilk = parseCSV(ilkText);
                registry.p = parseCSV(pText);

                generateGame();
            } catch (error) {
                console.error("Error loading CSV files:", error);
                alert("Could not load CSV data. Make sure ilks.csv and ps.csv are in the same folder and you are using a local server.");
            }
        }

        function parseCSV(text) {
            const rows = text.trim().split('\n').slice(1);
            return rows.map(row => {
                const [name, cost, deadly, color] = row.split(',');
                return {
                    name: name.trim(),
                    cost: parseFloat(cost),
                    isDeadly: deadly.trim().toLowerCase() === 'true',
                    color: color.trim()
                };
            });
        }

        // --- GAME LOGIC ---
        function generateGame() {
            if (registry.ilk.length === 0 || registry.p.length === 0) return;

            // Option B (Right Card)
            const isDeadly = Math.random() < 0.5;
            const possiblePs = isDeadly ? registry.p.filter(f => f.isDeadly) : registry.p.filter(f => !f.isDeadly);
            const itemP = possiblePs[Math.floor(Math.random() * possiblePs.length)];
            const itemI = registry.ilk[Math.floor(Math.random() * registry.ilk.length)];

            // Updated range: Math.random() * (Max - Min) + Min
            // (Math.random() * 4.9 + 0.1) results in a range of 0.1% to 5.0%
            const pPct = isDeadly ? +(Math.random() * 4.9 + 0.1).toFixed(2) : Math.floor(Math.random() * 60);
            const iPct = +(100 - pPct).toFixed(2);

            render('right', [
                { ...itemP, pct: pPct },
                { ...itemI, pct: iPct }
            ]);

            // Option A (Left Card - Classic Logic)
            const piss = registry.p.find(f => f.name === "Piss") || { cost: 0, color: "#FFD700" };
            const pepsi = registry.p.find(f => f.name === "Pepsi") || { cost: 0.03, color: "#2b1d1d" };
            const milk = registry.ilk.find(f => f.name === "Whole Milk") || { cost: 0.03, color: "#fdfbf7" };

            const pissPct = isDeadly ? Math.floor(Math.random() * 30) + 1 : Math.floor(Math.random() * 10) + 1;
            const remaining = 100 - pissPct;
            const milkPct = Math.floor(Math.random() * remaining);
            const pepsiPct = remaining - milkPct;

            render('left', [
                { name: "Piss", pct: pissPct, color: piss.color, cost: piss.cost },
                { name: "Whole Milk", pct: milkPct, color: milk.color, cost: milk.cost },
                { name: "Pepsi", pct: pepsiPct, color: pepsi.color, cost: pepsi.cost }
            ]);
        }

        function render(side, ingredients) {
            const listId = side === 'left' ? 'leftContent' : 'rightContent';
            const totalId = side === 'left' ? 'leftTotal' : 'rightTotal';
            const vizId = side === 'left' ? 'vizA' : 'vizB';

            let listHtml = "";
            let vizHtml = "";
            let totalCost = 0;

            ingredients.forEach(ing => {
                if (ing.pct <= 0) return;

                // 1. Calculate actual values for text and cost
                const oz = (ing.pct / 100 * 16);
                totalCost += (oz * ing.cost);

                // 2. Determine the Visual Height
                // If it's the Chaos side (right), the item is deadly, and pct is < 5, force 7% height
                let displayHeight = ing.pct;
                if (side === 'right' && ing.isDeadly && ing.pct < 5) {
                    displayHeight = 7;
                }

                // 3. Update the HTML
                // We use Number(ing.pct) for the label, but displayHeight for the CSS style
                listHtml += `<li><span class="percentage">${Number(ing.pct)}%</span> ${ing.name} <span class="oz-label">(${oz.toFixed(1)}oz)</span></li>`;
                vizHtml = `<div class="layer" style="height:${displayHeight}%; background-color:${ing.color}"></div>` + vizHtml;
            });

            document.getElementById(listId).innerHTML = listHtml;
            document.getElementById(totalId).innerText = `Total: $${totalCost.toFixed(2)}`;
            document.getElementById(vizId).innerHTML = vizHtml;
        }

        // Initialize on Load
        loadData();
    </script>
</body>
</html>